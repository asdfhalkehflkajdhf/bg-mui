 <!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="index.css" rel="stylesheet" />

	</head>

	<body>
		<!--标题栏部分-->
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">登录</h1>
		</header>
		
		<!--body部分-->
		<div class="mui-content">
			
			<div id="slider" class="mui-slider" >
			  <div class="mui-slider-group mui-slider-loop">
			    <!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
			    <div class="mui-slider-item mui-slider-item-duplicate">
			      <a href="#">
			        <img src="http://placehold.it/400x300">
			      </a>
			    </div>
			    <!-- 第一张 -->
			    <div class="mui-slider-item">
			      <a href="#">
			        <img src="http://placehold.it/400x300">
			      </a>
			    </div>
			    <!-- 第二张 -->
			    <div class="mui-slider-item">
			      <a href="#">
			        <img src="http://placehold.it/400x300">
			      </a>
			    </div>
			    <!-- 第三张 -->
			    <div class="mui-slider-item">
			      <a href="#">
			        <img src="http://placehold.it/400x300">
			      </a>
			    </div>
			    <!-- 第四张 -->
			    <div class="mui-slider-item">
			      <a href="#">
			        <img src="http://placehold.it/400x300">
			      </a>
			    </div>
			    <!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
			    <div class="mui-slider-item mui-slider-item-duplicate">
			      <a href="#">
			        <img src="http://placehold.it/400x300">
			      </a>
			    </div>
			  </div>
			  <div class="mui-slider-indicator">
			    <div class="mui-indicator mui-active"></div>
			    <div class="mui-indicator"></div>
			    <div class="mui-indicator"></div>
			    <div class="mui-indicator"></div>
			  </div>
			</div>
			
			<!--登录表单-->
			<form id='login-form' class="mui-input-group">
				<div class="mui-input-row">
					<label>手机号</label>
					<input id='phone' type="text" class="mui-input-clear mui-input" placeholder="请输入手机号" maxlength="11" onchange="changeButtonStatus();">
				</div>
				<div class="mui-input-row">
					<label>验证码</label>
					<input id='code' type="text" class="mui-input-clear mui-col-xs-3" placeholder="请输入验证码" maxlength="6">
				</div>
			</form>
		
			<!--验证登录按钮-->
			<div class="mui-content-padded">
				<button onclick="senmobile(60);" id="get_code" disabled="false" class=" mui-btn mui-btn-royal mui-btn-outlined mui-col-xs-3">
					获取验证码
				</button>
				<button id='login' class="mui-btn mui-btn-primary mui-col-xs-7 mui-pull-right" onclick="triggerLogin();">
					登录
				</button>	
			</div>
			
			<div class="mui-content-padded">
				<button id="announcements" class="mui-btn mui-btn-block mui-btn-link" onclick="openNewPage('page/announcements.html')">
					用户公告
				</button>
			</div>
			
			<button id="asdf" class="mui-btn mui-btn-block mui-btn-primary" onclick="openNewPage('page/main.html');">直接登录</button>
			<button id="asdf" class="mui-btn mui-btn-block mui-btn-primary" onclick="openNewPage('new_file.html');">测试</button>
			<!-- 底部版权说明 -->
			<div class="mui-content-padded oauth-area">
				说明
			</div>
		</div>
		
		<script src="js/mui.min.js"></script>
		<script src="common/call_writing.js"></script>
		<script>
			mui.init({
				statusBarBackground: '#f7f7f7'
			});
			
			
			function isPhone(v){
				var p1 = /^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/;
				var me = false;
				if(p1.test(v)) me=true;
				return me;
			}
			
			function changeButtonStatus(){
				
				var phoneObj = document.getElementById('phone');
				var get_code=document.getElementById('get_code');
//				检测手机号,成功可以获取,失败重新输入
				if(isPhone(phoneObj.value)){
					get_code.disabled=false;
					console.log("changeButtonStatus");
				}else{
					get_code.disabled=true;
					console.log("changeButtonStatus2");
				}
			}
			
			//验证码，倒计时
			var issend=true; 
			function senmobile(t){ 
			     if(issend){
			    //验证电话号码手机号码 
				    var phoneObj = document.getElementById('phone'); 
				    var codeObj = document.getElementById('code'); 
				    var get_code=document.getElementById('get_code'); 
			    	if (phoneObj.value != ""){
			        	var phoneVal=phoneObj.value;  
			        	if (isPhone(phoneVal) == false){  
			            	phoneObj.value='';
			            	mui.toast('请输入正确的手机号码');
			            	phoneObj.focus();
			            	return false;  
			        	}else if(codeObj.length<6){ 
			            	mui.toast('验证码长度不够6'); 
			            	return false;  
			        	}else{ 
			            	issend=false;
			            	mui.ajax('http://server-name/login.php',{
								data:{
									phone:phoneObj.value
								},
								dataType:'json',//服务器返回json格式数据
								type:'post',//HTTP请求类型
								timeout:10000,//超时时间设置为10秒；
								headers:{'Content-Type':'application/json'},	              
								success:function(data){
									//服务器返回响应，根据响应结果，分析是否登录成功；
									var data=$.parseJSON(data);
									//'验证码发送成功！'
									//'验证码发送失败！'
			                  		plus.nativeUI.toast(data.msg, {verticalAlign: 'center'});
			                  		update_time(t);			                  		
								},
								error:function(xhr,type,errorThrown){
									//异常处理；
									console.log("服务器链接失败");
									update_time(t);
								}
							});

			            } 
			    	}else{ 
			        	plus.nativeUI.toast('手机号码不能为空！', {verticalAlign: 'center'}); 
			        	return false; 
			    	}
				}
			}
 
			function update_a(num,t){
			    var get_code=document.getElementById('get_code'); 
			    if(num == t){
			        get_code.innerHTML =" 重新发送 ";  
			        issend=true;  
			    }else{  
			       var printnr = t-num;  
			        get_code.innerHTML =printnr +" 秒后重发";  
			    }
			}  
			function update_time(t){
				for(i=1;i<=t;i++) {  
                    window.setTimeout("update_a(" + i + ","+t+")", i * 1000);  
                }				
			}
			//登录请求
			function login(phone, uuid, code){
				console.log("lgoin");
	            	mui.ajax('http://server-name/login.php',{
					data:{
						phone:phone,
						code: code,
						uuid: uuid
					},
					dataType:'json',//服务器返回json格式数据
					type:'post',//HTTP请求类型
					timeout:10000,//超时时间设置为10秒；
					headers:{'Content-Type':'application/json'},
					success:function(data){
						//服务器返回响应，根据响应结果，分析是否登录成功；
						var data=$.parseJSON(data);
						//'验证码发送成功！'
						//'验证码发送失败！'
						var targetTab='page/main.html';
						if(data.code == 0 ){
							//打开新页面
							openNewPage(targetTab);
							//本地持久化
							plus.storage.setItem("phone", phoneObj.value);
							plus.storage.setItem("uuid", plus.device.uuid);
						}else{
 	                 		plus.nativeUI.toast(data.msg, {verticalAlign: 'center'});
						}
                 		for(i=1;i<=t;i++) {  
                            window.setTimeout("update_a(" + i + ","+t+")", i * 1000);  
                        }

					},
					error:function(xhr,type,errorThrown){
						//异常处理；
						plus.nativeUI.toast("链接服务器失败", {verticalAlign: 'center'});
						console.log(type);
					}
				});
			}
			
			
			function openNewPage(targetTab){
					mui.openWindow({
	   					url:targetTab,
	   					id: targetTab,
	   				});
			}
			
			function triggerLogin(){
			    var phoneObj = document.getElementById('phone'); 
			    var codeObj = document.getElementById('code');
			    if( isPhone(phoneObj.value) == false){
			    	mui.toast('请输入正确的手机号码');
			    	return;
			    }
			    if(codeObj.length<6){
			    	mui.toast('验证码长度不够6');
			    	return;			    	
			    }
			    
			    login(phoneObj.value, plus.device.uuid, codeObj.value);

			}
			
			function autoLogin(){
				var phone = plus.storage.getItem("phone");
				var uuid = plus.storage.getItem("uuid");
				if(phone == null || uuid == null)return;
				login(phone, uuid, "");
			}
			
			mui.plusReady(function() {
				
				console.log("当前页面URL："+plus.webview.currentWebview().getURL());
				
				//自动登录
				autoLogin();
				console.log("atuoLogin ok");
			
			
				console.log("plusReady ok");
			});
			

		</script>
	</body>

</html>